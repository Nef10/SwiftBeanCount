name: Code Coverage Comment

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  comment:
    if: ${{ github.event.workflow_run.event == 'pull_request' }}
    name: Comment Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Download Artifacts
        uses: actions/github-script@v8.0.0
        with:
          script: |
            var fs = require('fs');
            var artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ${{github.event.workflow_run.id }},
            });
            for (const artifact of artifacts.data.artifacts) {
              var download = await github.rest.actions.downloadArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id,
                archive_format: 'zip',
              });

              fs.writeFileSync('${{github.workspace}}/' + artifact.name + '.zip', Buffer.from(download.data));
            }
      - name: unzip Artifacts
        run: unzip '*.zip'
      - name: Get PR number
        run: echo "PR_NUMBER=$(cat $(find . -maxdepth 1 -type f -name 'PR_NUMBER*' | head -n 1))" >> $GITHUB_ENV
      - name: Generate code coverage report
        uses: Nef10/lcov-reporter-action@v0.5.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: macOS.info
          pr-number: ${{ env.PR_NUMBER }}
          hide-branch-coverage: true
          output-file: comment.html
      - name: Prepend minimum coverage required
        run: 'sed -i "1iMinimum coverage required: <b>$(cat ./.github/minimum_coverage.txt)%</b>\n<br />\n" comment.html'
      - name: Prepand failure info if needed
        run: |
          files=($(compgen -G "*-min-coverage-failed"))
          if (( ${#files[@]} )); then
            list=$(echo ${files} | sed 's/-min-coverage-failed$//' | paste -sd', ' -)
            sed -i "1i‚ùå <b>Minimum coverage check failed on: ${list}!</b>\n<br />\n" comment.html
          fi
      - name: Post code coverage report
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        with:
          path: comment.html
          number: ${{ env.PR_NUMBER }}
