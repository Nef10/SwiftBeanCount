name: CI

on:
  pull_request:
    branches:
    - main
  push:
    branches:
    - main

jobs:
  get_os:
    name: Determine supported OS
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    - name: Check and output correct matrix
      id: output_data
      run: |
        macos='macOS-latest'
        if [ -e .github/macos_version.txt ]
        then
            macos=$(cat ./.github/macos_version.txt)
        fi
        if [ -e .github/macos_only ]
        then
            echo "platform_matrix=['macOS']" >> $GITHUB_OUTPUT
            echo "coverage_platform=macOS" >> $GITHUB_OUTPUT
            echo "macos_version=$macos" >> $GITHUB_OUTPUT
        else
            echo "platform_matrix=['macOS', 'ubuntu', 'iOS']" >> $GITHUB_OUTPUT
            echo "coverage_platform=ubuntu" >> $GITHUB_OUTPUT
            echo "macos_version=$macos" >> $GITHUB_OUTPUT
        fi
    outputs:
        platform_matrix: ${{ steps.output_data.outputs.platform_matrix }}
        coverage_platform: ${{ steps.output_data.outputs.coverage_platform }}
        macos_version: ${{ steps.output_data.outputs.macos_version }}

  test:
    name: ${{ matrix.platform }} Tests with Swift ${{ matrix.swift }}
    needs: get_os
    strategy:
      fail-fast: false
      matrix:
        platform: ${{fromJson(needs.get_os.outputs.platform_matrix)}}
        swift: ["6.2.3"]
        include:
          - platform: macOS
            os: ${{ needs.get_os.outputs.macos_version }}
          - platform: ubuntu
            os: ubuntu-latest
          - platform: iOS
            os: macos-26
            destination: 'platform=iOS Simulator,OS=26.1,name=iPhone 17 Pro'
            xcode-version: '26.2' # Need to match Xcode version to iOS + Swift version
    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    - name: Install Swift
      if : ${{ matrix.platform != 'iOS' }}
      uses: swift-actions/setup-swift@v3.0.0-beta.1
      with:
        swift-version: "${{ matrix.swift }}"
        skip-verify-signature: ${{ matrix.os == 'ubuntu-latest' }}
    - name: Setup Xcode
      if : ${{ matrix.platform == 'iOS' }}
      uses: maxim-lobanov/setup-xcode@v1.6.0
      with:
        xcode-version: ${{ matrix.xcode-version }}
    - name: Run tests
      if : ${{ matrix.platform != 'iOS' }}
      run: swift test --enable-code-coverage
    - name: Run iOS tests
      id: ios-tests
      if : ${{ matrix.platform == 'iOS' }}
      run: |
        mkdir -p ../DerivedData
        DERIVED_DATA_PATH=$PWD/../DerivedData
        echo "DERIVED_DATA_PATH=$DERIVED_DATA_PATH" >> $GITHUB_ENV
        SCHEME=$(xcodebuild test -list -json | jq -r "if .workspace.schemes | length == 1 then .workspace.schemes.[0] else .workspace.schemes | map(select(.|endswith(\"-Package\"))) | .[0] end")
        xcodebuild test -skipPackagePluginValidation -enableCodeCoverage YES -scheme "$SCHEME" -destination "${{ matrix.destination }}" -derivedDataPath "$DERIVED_DATA_PATH"
    - name: Save PR number
      if: ${{ matrix.platform == needs.get_os.outputs.coverage_platform }}
      run: |
        mkdir -p ./pr
        echo ${{ github.event.number }} > ./pr/NR
    - name: Upload PR number for Comment
      if: ${{ matrix.platform == needs.get_os.outputs.coverage_platform }}
      uses: actions/upload-artifact@v6
      with:
        name: pr
        path: pr/
    - name: Install lcov
      if: ${{ matrix.platform == 'iOS' }}
      run: brew install lcov
    - name: Generate test coverage report
      run: |
        mkdir -p "${{matrix.platform}}-coverage"

        CMD="llvm-cov"

        if [[ "$OSTYPE" == "darwin"* ]]; then
          PATH="/usr/local/opt/llvm/bin:$PATH"
        else
          # Workaround for GitHub Actions ubuntu image missing llvm-cov in PATH, if swift is pre-installed
          # If it is installed via swift-actions/setup-swift, llvm-cov is in PATH
          PATH="/usr/share/swift/usr/bin:$PATH"
        fi

        if ! command -v "$CMD" &> /dev/null; then
          CMD="xcrun llvm-cov"
        fi

        if [[ "${{matrix.platform}}" == "iOS" ]]; then
          INSTR_PROFILE_PATH=$(find $DERIVED_DATA_PATH -name "*.profdata")

          find $DERIVED_DATA_PATH -name '*.xctest' -print0 | while IFS= read -r -d '' file; do
            FILE_NAME=$(basename "$file" .xctest)
            $CMD export "$file/$FILE_NAME" --skip-functions --skip-branches -instr-profile="$INSTR_PROFILE_PATH" -ignore-filename-regex=".build|Tests|SourcePackages" -format="lcov" > $FILE_NAME.lcov
          done

          find . -maxdepth 1 -name "*.lcov" -exec echo -a {} \; | xargs lcov -o ${{matrix.platform}}-coverage/lcov.info
        else
          INSTR_PROFILE_PATH=".build/debug/codecov/default.profdata"
          XCTEST_PATH="$(find $(swift build --show-bin-path) -name '*.xctest')"

          if [[ "${{matrix.platform}}" == "macOS" ]]; then
            COV_BIN="${XCTEST_PATH}/Contents/MacOS/$(basename $XCTEST_PATH .xctest)"
          elif [[ "${{matrix.platform}}" == "ubuntu" ]]; then
            COV_BIN=$XCTEST_PATH
          fi

          $CMD export "${COV_BIN}" --skip-functions --skip-branches -instr-profile="$INSTR_PROFILE_PATH" -ignore-filename-regex=".build|Tests|SourcePackages" -format="lcov" > ${{matrix.platform}}-coverage/lcov.info
        fi
    - name: Upload Coverage Information for Comment
      uses: actions/upload-artifact@v6
      with:
        name: ${{matrix.platform}}-coverage
        path: ${{matrix.platform}}-coverage/
    - name: 'Read minimum coverage'
      run: echo "minimum_coverage=$(cat ./.github/minimum_coverage.txt)" >> $GITHUB_ENV
    - name: Enforce test coverage threshhold
      uses: VeryGoodOpenSource/very_good_coverage@v3.0.0
      with:
        path: ./${{matrix.platform}}-coverage/lcov.info
        min_coverage: ${{ env.minimum_coverage }}
